// Generated by CoffeeScript 1.7.1
(function() {
  var Nex, _,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  Nex = this.Nex || require('nex');

  _ = require('underscore');

  Nex.Widgets.Image = (function(_super) {
    __extends(Image, _super);

    Image.prototype.className = 'imagoimage';

    Image.prototype.defaults = {
      align: 'center center',
      sizemode: 'fit',
      hires: true,
      scale: 1,
      lazy: true,
      maxSize: 2560,
      noResize: false,
      mediasize: false,
      width: 'auto',
      height: 'auto'
    };

    Image.prototype.events = {
      'resize': 'render'
    };

    Image.prototype.elements = {
      '.image': 'image'
    };

    function Image() {
      this.setBackgroundSize = __bind(this.setBackgroundSize, this);
      this.calcMediaSize = __bind(this.calcMediaSize, this);
      this.imgLoaded = __bind(this.imgLoaded, this);
      this.preload = __bind(this.preload, this);
      this.onResize = __bind(this.onResize, this);
      this.render = __bind(this.render, this);
      var key, r, value, _ref;
      _ref = this.defaults;
      for (key in _ref) {
        value = _ref[key];
        this[key] = value;
      }
      Image.__super__.constructor.apply(this, arguments);
      this.logPrefix = '(App) Image: ';
      if (!this.src) {
        return this.log('Error: image widget rquires src');
      }
      if (!this.resolution) {
        return this.log('Error: image widget rquires resolution');
      }
      this.id = Nex.Utils.uuid();
      this.html('<div class="image"></div><div class="spin"></div><div class="spin2"></div>');
      if (typeof this.width === 'number') {
        this.el.width(this.width);
      }
      if (typeof this.height === 'number') {
        this.el.height(this.height);
      }
      this.el.addClass(this["class"]);
      if (this.style) {
        this.el.attr('style', this.style);
      }
      this.window = $(window);
      if (this.lazy) {
        this.window.on("resizestop." + this.id, this.preload);
      }
      if (!this.noResize) {
        this.window.on("resize." + this.id, _.throttle(this.onResize, 250));
      }
      if (this.lazy) {
        this.window.on("scrollstop." + this.id, this.preload);
      }
      if (typeof this.resolution === 'string') {
        r = this.resolution.split('x');
        this.resolution = {
          width: r[0],
          height: r[1]
        };
      }
      this.render();
    }

    Image.prototype.render = function() {
      if (this.released) {
        return;
      }
      if (!(this.el.width() || this.el.height())) {
        this.delay(this.render, 250);
        return;
      }
      return this.preload();
    };

    Image.prototype.resize = function(width, height) {
      if (width) {
        this.width = width;
      }
      if (height) {
        this.height = height;
      }
      return this.onResize();
    };

    Image.prototype.onResize = function() {
      return this.image.css('backgroundSize', this.calcMediaSize());
    };

    Image.prototype.preload = function(options) {
      var assetRatio, css, dpr, height, img, servingSize, sizemode, width, wrapperRatio;
      if (options == null) {
        options = {};
      }
      width = options.width || this.width;
      height = options.height || this.height;
      sizemode = options.sizemode || this.sizemode;
      if (this.status === 'preloading') {
        return this.log('tried to preload during preloading!!');
      }
      this.el.removeClass('loaded');
      if (sizemode !== this.sizemode) {
        this.sizemode = sizemode;
      }
      assetRatio = this.resolution.width / this.resolution.height;
      if (width === this.width || width === 'auto' && height === this.height || height === 'auto') {
        if (typeof this.width === 'number' && typeof this.height === 'number') {
          width = this.width;
          height = this.height;
        } else if (this.height === 'auto' && typeof this.width === 'number') {
          width = this.width;
          height = this.width * assetRatio;
          this.el.height(height);
        } else if (this.width === 'auto' && typeof this.height === 'number') {
          height = this.height;
          width = this.height * assetRatio;
          this.el.width(width);
        } else {
          width = parseInt(this.el.css('width'));
          height = parseInt(this.el.css('height'));
        }
      }
      if (!$.inviewport(this.el, {
        threshold: 0
      }) && this.lazy) {
        return;
      }
      this.status = 'preloading';
      if (this.lazy) {
        this.window.off("scrollstop." + this.id);
      }
      wrapperRatio = width / height;
      dpr = this.hires ? Math.ceil(window.devicePixelRatio) || 1 : 1;
      if (this.sizemode === 'crop') {
        if (assetRatio <= wrapperRatio) {
          servingSize = Math.round(Math.max(width, width / assetRatio));
        } else {
          servingSize = Math.round(Math.max(height, height * assetRatio));
        }
      } else {
        if (assetRatio <= wrapperRatio) {
          servingSize = Math.round(Math.max(height, height * assetRatio));
        } else {
          servingSize = Math.round(Math.max(width, width / assetRatio));
        }
      }
      servingSize = Math.min(servingSize * dpr, this.maxSize);
      if (servingSize === this.servingSize) {
        this.status = 'loaded';
        return;
      }
      this.servingSize = servingSize;
      this.servingUrl = "" + this.src + "=s" + (this.servingSize * this.scale);
      img = $('<img>').bind('load', this.imgLoaded);
      img.attr('src', this.servingUrl);
      css = {
        backgroundPosition: this.align,
        display: "inline-block"
      };
      if (typeof this.width === 'number') {
        css.width = "" + (parseInt(width, 10)) + "px";
      }
      if (typeof this.height === 'number') {
        css.height = "" + (parseInt(height, 10)) + "px";
      }
      return this.image.css(css);
    };

    Image.prototype.imgLoaded = function() {
      this.image.css({
        backgroundImage: "url(" + this.servingUrl + ")",
        backgroundSize: this.calcMediaSize()
      });
      this.delay(function() {
        return this.el.addClass('loaded');
      }, 250);
      this.trigger('loaded');
      return this.status = 'loaded';
    };

    Image.prototype.calcMediaSize = function(options) {
      var assetRatio, height, width, wrapperRatio;
      if (options == null) {
        options = {};
      }
      if (options.sizemode) {
        this.sizemode = options.sizemode;
      }
      width = +this.width || this.el.width();
      height = +this.height || this.el.height();
      assetRatio = this.resolution.width / this.resolution.height;
      wrapperRatio = width / height;
      if (this.sizemode === 'crop') {
        if (assetRatio < wrapperRatio) {
          return "100% auto";
        } else {
          return "auto 100%";
        }
      } else {
        if (assetRatio > wrapperRatio) {
          return "100% auto";
        } else {
          return "auto 100%";
        }
      }
    };

    Image.prototype.setBackgroundSize = function(options) {
      var assetRatio, height, value, width, wrapperRatio;
      if (options == null) {
        options = {};
      }
      if (options.sizemode) {
        this.sizemode = options.sizemode;
      }
      width = +this.width || this.el.width();
      height = +this.height || this.el.height();
      assetRatio = this.resolution.width / this.resolution.height;
      wrapperRatio = width / height;
      if (this.sizemode === 'crop') {
        if (assetRatio < wrapperRatio) {
          value = "100% auto";
        } else {
          value = "auto 100%";
        }
      } else {
        if (assetRatio > wrapperRatio) {
          value = "100% auto";
        } else {
          value = "auto 100%";
        }
      }
      return this.image.css({
        backgroundSize: value
      });
    };

    Image.prototype.activate = function() {
      Image.__super__.activate.apply(this, arguments);
      return this.preload();
    };

    Image.prototype.release = function() {
      this.window.off(this.id);
      this.released = true;
      return Image.__super__.release.apply(this, arguments);
    };

    return Image;

  })(Spine.Controller);

  module.exports = Nex.Widgets.Image;

}).call(this);

//# sourceMappingURL=image.map
