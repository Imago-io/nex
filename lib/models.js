// Generated by CoffeeScript 1.9.2
(function() {
  var Asset, CartItem, Collection, Generic, Image, Member, Proxy, Search, Setting, Video,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty,
    indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  Search = require("./search");

  Asset = (function(superClass) {
    extend(Asset, superClass);

    function Asset() {
      return Asset.__super__.constructor.apply(this, arguments);
    }

    Asset.configure('Asset');

    Asset.extend(Search);

    Asset.id_to_kind = function(id) {
      var kind;
      if (id.indexOf('Collection-') === 0) {
        kind = 'Collection';
      } else if (id.indexOf('Generic-') === 0) {
        kind = 'Generic';
      } else if (id.indexOf('Proxy-') === 0) {
        kind = 'Proxy';
      } else if (id.indexOf('Order-') === 0) {
        kind = 'Order';
      } else if (id.match(/[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}/)) {
        kind = 'Image';
      } else if (id.match(/[0-9a-z]{56}/)) {
        kind = 'Video';
      }
      return kind;
    };

    Asset.globalFind = function(id) {
      return this.get_model(id).find(id);
    };

    Asset.globalExists = function(id) {
      return this.get_model(id).exists(id);
    };

    Asset.get_model = function(id_or_kind) {
      return Nex.Models[id_or_kind] || Nex.Models[this.id_to_kind(id_or_kind)];
    };

    Asset.models = function() {
      var models;
      models = {
        Collection: Nex.Models.Collection,
        Image: Nex.Models.Image,
        Video: Nex.Models.Video,
        Proxy: Nex.Models.Proxy,
        Generic: Nex.Models.Generic
      };
      return models;
    };

    Asset.filter = function(callback, exclude) {
      var modelName, models, results;
      if (exclude == null) {
        exclude = [];
      }
      models = this.models();
      exclude = Spine.isArray(exclude) ? exclude : [exclude];
      results = [];
      for (modelName in models) {
        if (indexOf.call(exclude, modelName) >= 0) {
          continue;
        }
        results = results.concat(models[modelName].select(callback));
      }
      return results;
    };

    Asset.create_or_update = function(attrs, options) {
      var model;
      model = this.get_model(attrs.id);
      if (!model.exists(attrs.id)) {
        return model.create(attrs, options);
      }
      return model.update(attrs.id, attrs, options);
    };

    Asset.related = function(params) {
      params.context = params.context.id ? params.context.id : params.context;
      params.limit || (params.limit = 10);
      params.related = typeof context.getMeta === "function" ? context.getMeta(params.propname, []) : void 0;
      return this.get(params);
    };

    Asset.prototype._normalizeValue = function(value) {
      var i, len, normalized, val;
      if (!value) {
        return '';
      }
      if (value.hasOwnProperty('value')) {
        value = value.value;
      }
      if (Spine.isArray(value)) {
        normalized = (function() {
          var i, len, results1;
          results1 = [];
          for (i = 0, len = value.length; i < len; i++) {
            val = value[i];
            results1.push(Nex.Utils.normalize(val));
          }
          return results1;
        })();
        for (i = 0, len = normalized.length; i < len; i++) {
          val = normalized[i];
          if (indexOf.call(value, val) < 0) {
            value.push(val);
          }
        }
      }
      if (Spine.isArray(value)) {
        value = value.join(' ').toLowerCase();
      }
      if (typeof value === "string") {
        value = value.toLowerCase();
      }
      return value;
    };

    Asset.prototype.query = function(params, searchkey) {
      var attributes, i, j, key, len, len1, q, result, value;
      if (searchkey == null) {
        searchkey = void 0;
      }
      attributes = (function() {
        var results1;
        results1 = [];
        for (key in this.meta) {
          results1.push(key);
        }
        return results1;
      }).call(this);
      for (i = 0, len = attributes.length; i < len; i++) {
        key = attributes[i];
        if (searchkey && (searchkey !== key)) {
          continue;
        }
        value = this._normalizeValue(this.meta[key].value);
        for (j = 0, len1 = params.length; j < len1; j++) {
          q = params[j];
          result = typeof value.indexOf === "function" ? value.indexOf(q) : void 0;
          if (result === void 0) {
            continue;
          }
          if (result !== -1) {
            return true;
          }
        }
      }
      return false;
    };

    Asset.prototype.related = function(params) {
      params.context = this;
      return Asset.related(params);
    };

    Asset.prototype.getMeta = function(field, fallback) {
      var original_value, ref, ref1, ref2, ref3, ref4, ref5, ref6, ref7, value;
      if (fallback == null) {
        fallback = '';
      }
      if (!field) {
        return fallback;
      }
      if ((ref = this.meta[field]) != null ? (ref1 = ref.value) != null ? ref1.hasOwnProperty('value') : void 0 : void 0) {
        value = (ref2 = this.meta[field]) != null ? ref2.value.value : void 0;
      } else {
        value = (ref3 = this.meta[field]) != null ? ref3.value : void 0;
      }
      if ((ref4 = this.meta[field]) != null ? (ref5 = ref4.original_value) != null ? ref5.hasOwnProperty('value') : void 0 : void 0) {
        original_value = (ref6 = this.meta[field]) != null ? ref6.original_value.value : void 0;
      } else {
        original_value = (ref7 = this.meta[field]) != null ? ref7.original_value : void 0;
      }
      return value || original_value || fallback;
    };

    Asset.prototype.options = function() {
      var i, key, len, obj, opts, ref, ref1, ref2, variant;
      opts = {};
      ref = this.variants;
      for (i = 0, len = ref.length; i < len; i++) {
        variant = ref[i];
        ref1 = variant.meta;
        for (key in ref1) {
          obj = ref1[key];
          key = Nex.Utils.pluralize(key);
          opts[key] || (opts[key] = []);
          if (obj.value && (ref2 = obj.value, indexOf.call(opts[key], ref2) < 0)) {
            opts[key].push(obj.value);
          }
        }
      }
      return opts;
    };

    Asset.prototype.filterOptions = function(keyname, value) {
      var i, key, len, obj, opts, ref, ref1, ref2, variant, variants;
      variants = this.variants.filter(function(item) {
        var ref;
        return ((ref = item.meta[Nex.Utils.singularize(keyname)]) != null ? ref.value : void 0) === value;
      });
      opts = {
        mapping: {}
      };
      for (i = 0, len = variants.length; i < len; i++) {
        variant = variants[i];
        ref = variant.meta;
        for (key in ref) {
          obj = ref[key];
          key = Nex.Utils.pluralize(key);
          opts[key] || (opts[key] = []);
          if (ref1 = obj.value, indexOf.call(opts[key], ref1) < 0) {
            opts[key].push(obj.value);
          }
          opts.mapping[obj.value] = ((ref2 = variant.meta.stock) != null ? ref2.value : void 0) || 0;
        }
      }
      return opts;
    };

    Asset.prototype.discounted = function(index) {
      if (index == null) {
        index = 0;
      }
      if (!this.variants.length) {
        return false;
      }
      return this.variants[index].meta.discounted && ((this.variants[index].meta.discounted.value > 0) || (this.variants[index].meta.discounted.value[Nex.currency] > 0));
    };

    Asset.prototype.totalStock = function() {
      var v;
      if (!this.variants.length) {
        return 100;
      }
      return ((function() {
        var i, len, ref, ref1, results1;
        ref = this.variants;
        results1 = [];
        for (i = 0, len = ref.length; i < len; i++) {
          v = ref[i];
          results1.push((ref1 = v.meta.stock) != null ? ref1.value : void 0);
        }
        return results1;
      }).call(this)).reduce(function(t, s) {
        return t + s;
      });
    };

    Asset.prototype.price = function(currency, discounted, decimals) {
      var priceValue, ref, ref1;
      if (discounted == null) {
        discounted = false;
      }
      if (decimals == null) {
        decimals = true;
      }
      currency || (currency = Nex.currency);
      priceValue = ((ref = this.variants[0]) != null ? ref.meta.price.value[currency] : void 0) || this.getMeta('price', {
        currency: 0
      })[currency];
      if (discounted) {
        priceValue = ((ref1 = this.variants[0]) != null ? ref1.meta.discounted.value[currency] : void 0) || this.getMeta('discounted', {
          currency: 0
        })[currency];
      }
      return Nex.Utils.toPrice(priceValue, currency, decimals);
    };

    Asset.prototype.upvote = function() {
      var base, host, successResponse;
      (base = this.meta).likes || (base.likes = {
        value: 0
      });
      this.meta.likes.value++;
      this.meta.likes.liked = true;
      this.save();
      successResponse = (function(_this) {
        return function(data, status, xhr, options) {};
      })(this);
      host = Nex.data === 'online' && Nex.debug ? "http://" + Nex.tenant + ".imagoapp.com" : "";
      return $.ajax({
        contentType: 'application/json',
        dataType: 'json',
        processData: false,
        data: JSON.stringify({
          'likes': {
            'value': this.meta.likes.value
          }
        }),
        type: 'PUT',
        url: host + '/api/v2/metaupdate/' + this.id
      }).success(successResponse).error(function() {
        return this.log('error while upvoting');
      });
    };

    return Asset;

  })(Spine.Model);

  Collection = (function(superClass) {
    extend(Collection, superClass);

    function Collection() {
      return Collection.__super__.constructor.apply(this, arguments);
    }

    Collection.configure('Collection', 'kind', 'name', 'meta', 'path', 'serving_url', 'variants', 'date_created', 'date_modified', 'resolution', 'sort_by', 'sort_order', 'assets', 'hidden', 'normname', 'canonical');

    return Collection;

  })(Asset);

  Image = (function(superClass) {
    extend(Image, superClass);

    function Image() {
      return Image.__super__.constructor.apply(this, arguments);
    }

    Image.configure('Image', 'kind', 'name', 'meta', 'path', 'serving_url', 'variants', 'date_created', 'date_modified', 'resolution', 'filesize', 'normname', 'canonical');

    return Image;

  })(Asset);

  Video = (function(superClass) {
    extend(Video, superClass);

    function Video() {
      return Video.__super__.constructor.apply(this, arguments);
    }

    Video.configure('Video', 'kind', 'name', 'meta', 'path', 'serving_url', 'variants', 'date_created', 'date_modified', 'resolution', 'filesize', 'normname', 'canonical', 'formats');

    return Video;

  })(Asset);

  Generic = (function(superClass) {
    extend(Generic, superClass);

    function Generic() {
      return Generic.__super__.constructor.apply(this, arguments);
    }

    Generic.configure('Generic', 'kind', 'name', 'meta', 'serving_url', 'path', 'date_created', 'date_modified', 'resolution', 'normname', 'canonical', 'variants');

    return Generic;

  })(Asset);

  Proxy = (function(superClass) {
    extend(Proxy, superClass);

    function Proxy() {
      return Proxy.__super__.constructor.apply(this, arguments);
    }

    Proxy.configure('Proxy', 'kind', 'name', 'meta', 'path', 'serving_url', 'variants', 'date_created', 'date_modified', 'resolution', 'filesize', 'normname', 'proxypath', 'thumb');

    return Proxy;

  })(Asset);

  Setting = (function(superClass) {
    extend(Setting, superClass);

    function Setting() {
      return Setting.__super__.constructor.apply(this, arguments);
    }

    Setting.configure('Setting', 'label', 'name', 'value', 'section', 'order', 'type', 'visible', 'width', 'options');

    Setting.findAllBySection = function(section) {
      var settings;
      settings = this.findAllByAttribute('section', section);
      settings.sort(function(a, b) {
        return a.order - b.order;
      });
      return settings;
    };

    Setting.findByName = function(name) {
      return this.findByAttribute('name', name);
    };

    Setting.ensureCurrency = function() {
      var jqxhr;
      if (Nex.currency === Nex.Utils.cookie('currency')) {
        return;
      }
      Nex.Utils.cookie('currency', Nex.currency);
      return jqxhr = $.ajax("/api/v2/cart", {
        type: "POST",
        data: JSON.stringify({
          currency: Nex.currency
        })
      });
    };

    Setting.currency = function() {
      var currencies, sessioncur;
      sessioncur = Nex.Utils.getCurrencyByCode(Nex.country);
      currencies = this.findByName('currencies').value;
      if (indexOf.call(currencies, sessioncur) >= 0) {
        return sessioncur;
      } else {
        return currencies[0];
      }
    };

    Setting.setSessionData = function() {
      var ref, ref1, ref2, ref3, ref4;
      Nex.currencies = (ref = this.findByName('currencies')) != null ? ref.value : void 0;
      Nex.ipaddress = (ref1 = this.findByName('ipaddress')) != null ? ref1.value : void 0;
      Nex.country = (ref2 = this.findByName('country')) != null ? ref2.value : void 0;
      Nex.city = (ref3 = this.findByName('city')) != null ? ref3.value : void 0;
      Nex.region = (ref4 = this.findByName('region')) != null ? ref4.value : void 0;
      Nex.currency = this.currency();
      return $.ajax({
        type: 'GET',
        url: 'http://www.telize.com/geoip'
      }).success((function(_this) {
        return function(data) {
          Nex.country = data.country_code;
          Nex.city = data.city;
          Nex.region = data.region_code;
          return Nex.currency = _this.currency();
        };
      })(this)).error(function() {
        return typeof console !== "undefined" && console !== null ? console.log('fetch error for geoip') : void 0;
      });
    };

    Setting.extend(Spine.Model.Ajax);

    return Setting;

  })(Spine.Model);

  Member = (function(superClass) {
    extend(Member, superClass);

    function Member() {
      return Member.__super__.constructor.apply(this, arguments);
    }

    Member.configure('Member', 'email', 'first_name', 'last_name');

    Member.getMember = function() {
      var deferred, promise, successResponse;
      deferred = $.Deferred();
      promise = deferred.promise();
      successResponse = (function(_this) {
        return function(data, status, xhr, options) {
          var member;
          member = data.email ? _this.create(data) : void 0;
          return deferred.resolve(member);
        };
      })(this);
      $.ajax({
        contentType: 'application/json',
        dataType: 'json',
        processData: false,
        headers: Spine.Ajax.defaults,
        type: 'GET',
        url: '/api/v2/member'
      }).success(successResponse).error(function() {
        return deferred.resolve();
      });
      return promise;
    };

    Member.login = function() {
      return this._axaxCall('POST', {
        action: 'loginurl'
      });
    };

    Member.logout = function() {
      return this._axaxCall('POST', {
        action: 'logouturl'
      });
    };

    Member.checkout = function() {
      Setting.ensureCurrency();
      return this._axaxCall('POST', {
        action: 'checkout'
      });
    };

    Member._axaxCall = function(type, data) {
      var deferred, promise;
      deferred = $.Deferred();
      promise = deferred.promise();
      $.ajax({
        contentType: 'application/json',
        dataType: 'json',
        processData: false,
        headers: Spine.Ajax.defaults,
        type: type,
        data: JSON.stringify(data),
        url: '/api/v2/member'
      }).success(function(data, status, xhr, options) {
        if (data.url) {
          return window.location = data.url;
        } else {
          return deferred.resolve(data);
        }
      }).error(function() {
        return typeof console !== "undefined" && console !== null ? console.log('error') : void 0;
      });
      return promise;
    };

    return Member;

  })(Spine.Model);

  CartItem = (function(superClass) {
    extend(CartItem, superClass);

    function CartItem() {
      return CartItem.__super__.constructor.apply(this, arguments);
    }

    CartItem.configure('CartItem', 'meta', 'serving_url', 'quantity', 'price', 'color', 'size', 'itemid', 'headline', 'description');

    CartItem.addToCart = function(itemid, quantity, options) {
      var existing, item;
      if (options == null) {
        options = {
          'size': '',
          'color': '',
          headline: '',
          description: ''
        };
      }
      existing = this.select(function(item) {
        return item.itemid === itemid;
      });
      if (existing.length) {
        item = existing[0];
        item.quantity = item.quantity + quantity;
        item.save();
        return;
      }
      item = {
        itemid: itemid,
        quantity: quantity,
        color: options != null ? options.color : void 0,
        size: options != null ? options.size : void 0,
        serving_url: options != null ? options.serving_url : void 0,
        price: options != null ? options.price : void 0,
        headline: options != null ? options.headline : void 0,
        description: options != null ? options.description : void 0
      };
      return this.create(item);
    };

    CartItem.extend(Spine.Model.Ajax);

    return CartItem;

  })(Spine.Model);

  Spine.Ajax.defaults.headers['NexClient'] = Nex.client;

  Nex.Models = {
    Collection: Collection,
    Asset: Asset,
    Image: Image,
    Video: Video,
    Proxy: Proxy,
    Setting: Setting,
    Generic: Generic,
    Member: Member,
    CartItem: CartItem
  };

  module.exports = Nex.Models;

}).call(this);
